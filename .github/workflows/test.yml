name: test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: weft_lustre_ui
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - uses: erlef/setup-beam@v1
        with:
          otp-version: "28"
          gleam-version: "1.14.0"
          rebar3-version: "3"
      - run: sudo apt-get update && sudo apt-get install -y imagemagick
      - id: hex_deps
        name: Check Hex dependency availability
        run: |
          set -euo pipefail
          check_pkg() {
            local pkg="$1"
            local status
            status="$(curl -sS --max-time 15 --retry 2 -o /dev/null -w '%{http_code}' "https://hex.pm/api/packages/$pkg" || true)"
            if [[ "$status" == "200" ]]; then
              echo "ok: $pkg is published"
              return 0
            fi
            echo "missing: $pkg (status=$status)"
            return 1
          }

          if check_pkg "weft" && check_pkg "weft_lustre"; then
            echo "deps_ready=true" >> "$GITHUB_OUTPUT"
          else
            echo "deps_ready=false" >> "$GITHUB_OUTPUT"
          fi
      - if: steps.hex_deps.outputs.deps_ready != 'true'
        run: |
          echo "Hex deps are not published yet; running transitional checks only."
          bash scripts/grep-gates.sh
          gleam format --check src test
        working-directory: weft_lustre_ui
      - if: steps.hex_deps.outputs.deps_ready == 'true'
        run: gleam deps download
        working-directory: weft_lustre_ui
      - if: steps.hex_deps.outputs.deps_ready == 'true'
        run: bash scripts/check.sh
        working-directory: weft_lustre_ui
      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-benchmark-visual
          path: weft_lustre_ui/examples/dashboard_benchmark/visual-artifacts
